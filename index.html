<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>韓国語フラッシュカード</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Interフォントの読み込み（Tailwindのデフォルト） */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }

        /* 3Dフリップアニメーション用のスタイル */
        .card-container {
            perspective: 1000px;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-container.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden; /* 背面を非表示 */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
        }
        /* カードの表面（韓国語） */
        .card-front {
            background-color: #374151; /* bg-gray-700 */
            color: white;
        }
        /* カードの裏面（日本語） */
        .card-back {
            background-color: #4B5563; /* bg-gray-600 */
            color: white;
            transform: rotateY(180deg); /* 裏面は最初から反転 */
        }
        /* 読み上げボタンのスタイル */
        .speak-button {
            position: absolute;
            bottom: 1rem; /* 16px */
            right: 1rem; /* 16px */
            padding: 0.5rem; /* 8px */
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .speak-button:hover {
            background-color: rgba(0, 0, 0, 0.4);
        }
        .speak-button svg {
            width: 1.5rem; /* 24px */
            height: 1.5rem; /* 24px */
            fill: white;
        }

        #苦手な単語リスト li {
            background-color: #374151; /* bg-gray-700 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-900 text-white p-4">

    <div class="w-full max-w-md mx-auto">
        <h1 class="text-3xl font-bold text-center mb-6 text-indigo-400">韓国語フラッシュカード</h1>
        
        <!-- 読み込み/エラーメッセージ表示 -->
        <div id="status-message" class="text-center text-lg text-gray-400 mb-6">
            <code>words.csv</code> を読み込んでいます...
        </div>


        <!-- フラッシュカードUI -->
        <div id="card-ui" class="hidden">
            <!-- フラッシュカード本体 -->
            <div id="flashcard-container" class="card-container w-full h-64 mb-6 cursor-pointer">
                <div id="card-inner" class="card-inner">
                    <!-- カードの表面 (韓国語) -->
                    <div class="card-face card-front">
                        <p id="card-front-text" class="text-4xl font-semibold text-center"></p>
                        <p id="card-front-reading" class="text-xl text-gray-300 mt-2"></p>
                        
                        <button id="speak-korean-button" class="speak-button" title="韓国語を読み上げる">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                        </button>
                    </div>
                    <!-- カードの裏面 (日本語) -->
                    <div class="card-face card-back">
                        <p id="card-back-text" class="text-3xl text-center"></p>
                        <button id="speak-japanese-button" class="speak-button" title="日本語を読み上げる">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 読み方 トグルスイッチ -->
            <div class="flex justify-center items-center mb-4 text-gray-300 hidden" id="reading-toggle-container">
                <input type="checkbox" id="toggle-reading" checked class="w-4 h-4 text-indigo-600 bg-gray-700 border-gray-600 rounded focus:ring-indigo-500 focus:ring-2">
                <label for="toggle-reading" class="ml-2 text-sm select-none cursor-pointer">読み仮名を表示</label>
            </div>

            <!-- 
                (修正) わかった/わからなかった ボタン
                'hidden' クラス (display: none) を削除し、
                'opacity-0' (透明) と 'invisible' (非表示だがスペースは確保) をデフォルトにします。
                'transition-opacity' でフェードイン/アウトするようにします。
            -->
            <div id="answer-buttons" class="flex justify-between items-center mb-4 opacity-0 invisible transition-opacity duration-300">
                <button id="incorrect-button" class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-md w-1/2 mr-2">
                    わからなかった
                </button>
                <button id="correct-button" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-md w-1/2 ml-2">
                    わかった
                </button>
            </div>
            
            <!-- カードの残り枚数カウンター (ここがずれる問題があった) -->
            <div id="session-counter" class="text-center text-lg text-gray-400 mb-4"></div>
        </div>
        
        <!-- 結果表示画面 -->
        <div id="results-screen" class="hidden text-center p-6 bg-gray-800 rounded-xl shadow-2xl">
            <h2 class="text-3xl font-bold text-indigo-400 mb-4">セッション完了！</h2>
            
            <div class="text-xl mb-4">
                正答率: <span id="accuracy-rate" class="font-bold text-green-400"></span>
            </div>
            <p class="text-gray-400 mb-2">(正解 <span id="correct-count"></span> 回 / 総回答 <span id="total-answers"></span> 回)</p>
            
            <div class="mt-6 text-left">
                <h3 class="text-xl font-semibold mb-3 text-gray-300">苦手な単語</h3>
                <ul id="苦手な単語リスト" class="max-h-48 overflow-y-auto bg-gray-900 p-3 rounded-lg">
                    <!-- 苦手な単語がここに挿入されます -->
                </ul>
                <p id="no-incorrect-words" class="text-gray-500 text-center hidden">パーフェクトです！</p>
            </div>
            
            <button id="restart-button" class="mt-8 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-lg transition-colors shadow-md w-full">
                もう一度初めから
            </button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- DOM要素の取得 ---
            const statusMessage = document.getElementById('status-message');
            const cardUi = document.getElementById('card-ui');
            const cardContainer = document.getElementById('flashcard-container');
            const cardInner = document.getElementById('card-inner');
            const cardFrontText = document.getElementById('card-front-text');
            const cardBackText = document.getElementById('card-back-text');
            const cardFrontReading = document.getElementById('card-front-reading');
            const readingToggleContainer = document.getElementById('reading-toggle-container');
            const toggleReading = document.getElementById('toggle-reading');
            
            const speakKoreanButton = document.getElementById('speak-korean-button');
            const speakJapaneseButton = document.getElementById('speak-japanese-button');
            
            const answerButtons = document.getElementById('answer-buttons');
            const correctButton = document.getElementById('correct-button');
            const incorrectButton = document.getElementById('incorrect-button');
            const sessionCounter = document.getElementById('session-counter');
            
            const resultsScreen = document.getElementById('results-screen');
            const accuracyRate = document.getElementById('accuracy-rate');
            const correctCountEl = document.getElementById('correct-count');
            const totalAnswersEl = document.getElementById('total-answers');
            const incorrectWordsList = document.getElementById('苦手な単語リスト');
            const noIncorrectWords = document.getElementById('no-incorrect-words');
            const restartButton = document.getElementById('restart-button');

            // --- 変数の初期化 ---
            let masterFlashcards = []; 
            let sessionQueue = [];     
            let currentCard = null;    
            let incorrectCards = new Set(); 
            let correctCount = 0;       
            let incorrectCount = 0;     
            let isFlipped = false;
            let showReading = true;
            let hasReadingData = false;
            let isTransitioning = false; 
            
            const synth = window.speechSynthesis;
            if (!synth) {
                console.warn("お使いのブラウザは音声読み上げに対応していません。");
                speakKoreanButton.style.display = 'none';
                speakJapaneseButton.style.display = 'none';
            }

            // --- CSV読み込み ---
            async function loadCSVData() {
                try {
                    const response = await fetch('words.csv');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const text = await response.text();
                    parseCSV(text);
                } catch (error) {
                    console.error('CSVの読み込みに失敗しました:', error);
                    displayError(`<code>words.csv</code> の読み込みに失敗しました。サーバー上にファイルがあるか確認してください。`);
                }
            }

            function displayError(message) {
                statusMessage.innerHTML = message;
                statusMessage.classList.remove('text-gray-400');
                statusMessage.classList.add('text-red-500');
                cardUi.classList.add('hidden');
            }
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function parseCSV(csvText) {
                masterFlashcards = [];
                hasReadingData = false;
                
                const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
                const header = lines[0] ? lines[0].trim().toLowerCase() : '';
                const headerIndex = (header === 'jp,kr' || header === 'jp,kr,read') ? 1 : 0;
                
                const dataLines = lines.slice(headerIndex);

                dataLines.forEach(line => {
                    const parts = line.split(',');
                    if (parts.length >= 2) {
                        const japanese = parts[0].trim();
                        const korean = parts[1].trim();
                        const reading = (parts.length >= 3) ? parts[2].trim() : '';
                        
                        if (japanese && korean) {
                            masterFlashcards.push({ japanese: japanese, korean: korean, reading: reading });
                            if (reading) {
                                hasReadingData = true;
                            }
                        }
                    }
                });

                if (masterFlashcards.length > 0) {
                    if (hasReadingData) {
                        readingToggleContainer.classList.remove('hidden');
                    } else {
                        readingToggleContainer.classList.add('hidden');
                    }
                    startSession();
                } else {
                    displayError("CSVの形式が正しくないか、データが空です (jp,kr または jp,kr,read 形式)。");
                }
            }

            // --- セッション管理 ---

            function startSession() {
                correctCount = masterFlashcards.length;
                incorrectCount = 0;
                incorrectCards.clear();
                
                sessionQueue = shuffleArray([...masterFlashcards]);
                
                resultsScreen.classList.add('hidden');
                cardUi.classList.remove('hidden');
                statusMessage.classList.add('hidden');
                
                updateCard();
            }

            function updateCard() {
                if (sessionQueue.length === 0) {
                    showResults();
                    return;
                }
                
                isTransitioning = false; 

                if (isFlipped) {
                    cardContainer.classList.remove('is-flipped');
                    isFlipped = false;
                }
                
                currentCard = sessionQueue.shift();
                
                // (修正) 'hidden' の代わりに opacity と visibility を操作
                answerButtons.classList.add('opacity-0', 'invisible');
                answerButtons.classList.remove('opacity-100', 'visible');
                
                // カードの内容をセット
                cardFrontText.textContent = currentCard.korean;
                cardBackText.textContent = currentCard.japanese;
                
                if (showReading && hasReadingData && currentCard.reading) {
                    cardFrontReading.textContent = currentCard.reading;
                    cardFrontReading.classList.remove('hidden');
                } else {
                    cardFrontReading.textContent = '';
                    cardFrontReading.classList.add('hidden');
                }
                
                sessionCounter.textContent = `残り: ${sessionQueue.length + 1}`;
            }

            function flipCard() {
                if (isTransitioning) return;
                
                isFlipped = !isFlipped;
                cardContainer.classList.toggle('is-flipped');
                
                if (isFlipped) {
                    // (修正) 'hidden' の代わりに opacity と visibility を操作
                    answerButtons.classList.remove('opacity-0', 'invisible');
                    answerButtons.classList.add('opacity-100', 'visible');
                } else {
                    // (修正) 'hidden' の代わりに opacity と visibility を操作
                    answerButtons.classList.add('opacity-0', 'invisible');
                    answerButtons.classList.remove('opacity-100', 'visible');
                }
            }

            function handleCorrect() {
                if (isTransitioning) return;
                isTransitioning = true;
                
                // (修正) ボタンを（アニメーション付きで）隠す
                answerButtons.classList.add('opacity-0', 'invisible');
                answerButtons.classList.remove('opacity-100', 'visible');
                
                if (isFlipped) {
                    cardContainer.classList.remove('is-flipped');
                    isFlipped = false;
                    setTimeout(updateCard, 600); // 600msはフリップアニメーションの時間
                } else {
                    updateCard();
                }
            }

            function handleIncorrect() {
                if (isTransitioning) return;
                isTransitioning = true;

                incorrectCount++;
                incorrectCards.add(currentCard);
                sessionQueue.push(currentCard);
                
                // (修正) ボタンを（アニメーション付きで）隠す
                answerButtons.classList.add('opacity-0', 'invisible');
                answerButtons.classList.remove('opacity-100', 'visible');
                
                if (isFlipped) {
                    cardContainer.classList.remove('is-flipped');
                    isFlipped = false;
                    setTimeout(updateCard, 600); // 600msはフリップアニメーションの時間
                } else {
                    updateCard();
                }
            }

            function showResults() {
                cardUi.classList.add('hidden');
                resultsScreen.classList.remove('hidden');
                
                const totalAnswers = correctCount + incorrectCount;
                const accuracy = (totalAnswers === 0) ? 0 : Math.round((correctCount / totalAnswers) * 100);
                
                accuracyRate.textContent = `${accuracy}%`;
                correctCountEl.textContent = correctCount;
                totalAnswersEl.textContent = totalAnswers;
                
                incorrectWordsList.innerHTML = '';
                if (incorrectCards.size > 0) {
                    incorrectWordsList.classList.remove('hidden'); // (追加) リストを表示
                    noIncorrectWords.classList.add('hidden');
                    incorrectCards.forEach(card => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${card.korean}</span> <span class="text-gray-400">${card.japanese}</span>`;
                        incorrectWordsList.appendChild(li);
                    });
                } else {
                    incorrectWordsList.classList.add('hidden'); // (追加) リストを非表示
                    noIncorrectWords.classList.remove('hidden');
                }
            }

            // --- イベントリスナー ---
            correctButton.addEventListener('click', handleCorrect);
            incorrectButton.addEventListener('click', handleIncorrect);
            restartButton.addEventListener('click', startSession);
            cardContainer.addEventListener('click', flipCard);
            
            toggleReading.addEventListener('change', () => {
                showReading = toggleReading.checked;
                if (currentCard) {
                    if (showReading && hasReadingData && currentCard.reading) {
                        cardFrontReading.textContent = currentCard.reading;
                        cardFrontReading.classList.remove('hidden');
                    } else {
                        cardFrontReading.textContent = '';
                        cardFrontReading.classList.add('hidden');
                    }
                }
            });
            
            // --- 読み上げ機能 ---
            speakKoreanButton.addEventListener('click', (event) => {
                event.stopPropagation(); 
                if (currentCard) {
                    speakText(currentCard.korean, 'ko-KR');
                }
            });
            
            speakJapaneseButton.addEventListener('click', (event) => {
                event.stopPropagation();
                if (currentCard) {
                    speakText(currentCard.japanese, 'ja-JP');
                }
            });

            function speakText(text, lang) {
                if (!synth || !text) return;
                synth.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                const voices = synth.getVoices();
                let specificVoice = voices.find(voice => voice.lang === lang);
                if (specificVoice) {
                    utterance.voice = specificVoice;
                } else {
                     console.warn(`言語 ${lang} の音声が見つかりませんでした。デフォルトの音声を使用します。`);
                }
                synth.speak(utterance);
            }
            
            if (synth && synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = () => synth.getVoices();
            }

            loadCSVData();
        });
    </script>

</body>
</html>
